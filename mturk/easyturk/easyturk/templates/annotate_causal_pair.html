<html>
<head>
  <title>Causation</title>
  <!-- easyturk depends on these libraries -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/json3/3.3.2/json3.min.js'></script>
  <!-- end of required libraries -->
  <script src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js'></script>
  <style>
    #counter {
      margin: 0 10px;
      font-size: 20pt;
      font-weight: bold;
    }
    img {
        height: 300px;
        max-width:100%;
    }
    img.example {
      height: 200px;
    }
    .tasks-container {
      margin-top: 15px;
      margin-bottom: 30px;
      background-color: #DBDBDB;
    }
    .examples-container {
      margin-top: 15px;
      margin-bottom: 30px;
      background-color: #9fbccb;
    }
    .instructions-container {
      margin-top: 15px;
      margin-bottom: 30px;
      background-color: #F0EAD6;
    }
    p {
      font-size: 17px;
      text-align: center;
    }
    li {
        font-size: 22px;
    }
    div {
        font-size: 22px;
    }
    #image-container{
        box-sizing: border-box;
        display: flex;
        flex-wrap: nowrap;
        justify-content: center;
    }
    .flex-item {
  margin: 1em;
  position: relative;
  text-align: center;
  flex-basis: 250px;
  max-width: 250px;
  min-width: 60px;
        align-self: center;
}
    input[type='radio'] { transform: scale(2); }
  </style>
</head>
<body>
<div class='container instructions-container'>
  <div id='instructions-section'>
    <div class='instructions'>
      <div class='row'>
        <div class='col-md-12'>
          <h1>Instructions</h1>
        </div>
      </div>
      <div class='row'>
        <div class='col-md-12'>
          <ul>
            <li>
                In this survey, we are interested in finding causal relations between objects in a scene, as opposed to just correlations.
                Your task is to say whether you think intervening on the presence (aka making present / absent) of one object in a scene would change your expectation of seeing the other object present.
                A more detailed explanation is below, and an example is also given in this video: <a href="https://drive.google.com/file/d/1e8ZuUa9233DiCDi6Ibpob4Z1PNopOCpG/view?usp=sharing" target="_blank">Explanation video</a>
                </li>
              <h2>
                  What we mean by 'causing'
              </h2>
            <li>
                For example, take a rain cloud, an umbrella and a puddle: the umbrella and the puddle are certainly correlated: if you see the one, you have an increased expectation of seeing the other.
                However, the presence of the umbrella does not <i>cause</i> the presence of the puddle: if I would just put an umbrella in the scene, that wouldn't make puddles appear.
                The correlation happens because of the rain cloud: it <i>does cause</i> the puddle, and it also causes the umbrella: if I 'put' a raining rain cloud in a scene,
                I can expect umbrellas and puddles to start appearing in my scene too.<br \>
                  We write this down compactly as "rain cloud" → "umbrella" and "rain cloud" → "puddle", so "umbrella" ← "rain cloud" → "puddle"<br \>
                Note that we also talk of causation when the presence of one object causes your expectation of seeing the other object to <i>decrease</i>: for example,
                  if I put a rain cloud in a scene, then I expect to see <i>fewer</i> sunglasses in the scene: in this case it is also true that "raincloud → sunglasses".
              </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<div class='container examples-container'>
  <div class='container'>
    <h2 id="x-and-y-text">
    </h2>
    <li>
        To help you understand what context these objects appear in, here are randomly picked example scenes where the items were detected.
    </li>
    </div>
    <div id='image-container'></div>
</div>

<div class='container tasks-container'>
  <div class='container-fluid'>
    <br />
    <h4>
        Select the option that seems correct to you.
    </h4>
    <div class='row'>
        <label id="x-to-y-label">
            <input type="radio" id="x-to-y" name="cause-direction" value="x-to-y">
        </label>
        </div>
    <div class='row'>
          <label id="y-to-x-label">
          <input type="radio" id="y-to-x" name="cause-direction" value="y-to-x"></label><br>
        </div>
    <div class='row'>
          <label id="z-to-xy-label">
          <input type="radio" id="z-to-xy" name="cause-direction" value="z-to-xy"></label>
        </div>
    <div class='row'>
          <label id="x-is-y-label">
          <input type="radio" id="x-is-y" name="cause-direction" value="x-is-y"></label>
        </div>
    <div class='row justify-content-center'>
        <h4>If you selected the option with "something else", write here what that "something else" could be (it does not have to be an object, but can be anything).
            If you can't think of something, write "?".</h4>
        <textarea type="text" name="confounder" id='confounder' rows="3" cols='50'></textarea>
    </div>

        <h4>Tell us how confident you are in your choice on a scale of 1 (not confident at all) to 3 (very confident).</h4>
    <div class='row'>
        <label>
            <input type="radio" id="confidence_1" name="confidence" value="confidence_1">&nbsp;&nbsp;1
        </label>
        </div>
    <div class='row'>
          <label>
          <input type="radio" id="confidence_2" name="confidence" value="confidence_2">&nbsp;&nbsp;2</label><br>
        </div>
    <div class='row'>
          <label>
          <input type="radio" id="confidence_3" name="confidence" value="confidence_3">&nbsp;&nbsp;3</label>
        </div>
    <div class='row justify-content-center' style='margin-top: 10px; padding-bottom: 10px;'>
      <div class='col-1'>
        <button id='prev-btn' class='btn btn-lg btn-primary' disabled>Back</button>
      </div>
      <div class='col-2'>
        <span id='counter'>
          <span class='counter-top'></span> / <span class='counter-bottom'></span>
        </span>
      </div>
      <div class='col-1'>
        <button id='next-btn' class='btn btn-lg btn-primary' disabled>Next</button>
      </div>
    </div>
  </div>
</div>

<!--IMPORTANT: This import contains all the functions you need to read in your input data and send back worker outputs.-->  
{% include "easyturk.html" %}

  <script>
    // Define some default input.
    // It is good practice to define standard inputs for a task which will be overwritten when launching
    // your actual task. The default inputs allow you to render and debug your task locally.
    var DEFAULT_INPUT = [
        {
            'joint_url': 'https://media1.popsugar-assets.com/files/thumbor/iPi5DnezSUgX8wE5OH9lC72CK_s/fit-in/1024x1024/filters:format_auto-!!-:strip_icc-!!-/2015/01/04/292/n/1922153/2588c207f22a7d36_Kirbie/i/Women-use-products-incorrectly.jpg',
            'marginal_url_x': 'http://i.dailymail.co.uk/i/pix/2011/11/28/article-2067304-0EF97A1700000578-978_634x779.jpg',
            'marginal_url_y': 'https://www.thestar.com/content/dam/thestar/entertainment/stage/2014/10/10/michael_cera_matures_as_an_actor_in_this_is_our_youth/michael_cera.jpg.size.custom.crop.1086x776.jpg',
            'word_X': 'shirt', 'word_Y': 'man'
        },
        {
            'joint_url': '',
            'marginal_url_x': 'https://ak0.picdn.net/shutterstock/videos/31507030/thumb/1.jpg',
            'marginal_url_y': 'http://tandgflooring.com/wp-content/uploads/2015/06/BRAZCHE_BANANAREP_COM_02.jpg',
            'word_X': 'tree',
            'word_Y': 'wall'},
        {'joint_url': 'https://ak0.picdn.net/shutterstock/videos/3501620/thumb/1.jpg', 'marginal_url_x': 'https://ak4.picdn.net/shutterstock/videos/22081894/thumb/1.jpg', 'marginal_url_y': 'https://smedia2.intoday.in/btmt/images/stories/burger_660_110117115734.jpg', 'word_X': 'french fry', 'word_Y': 'fry'}
        ]

    var input = null;

    // This is where we will be collecting the responses for each image;
    {#var captions = [];#}

    var cause_directions = [];
    var confounders = [];
    var confidences = [];
    // Some variables to track state of the HIT.
    var idx = 0;
    var enabled = false;

    function main() {
      // If this is a HIT on AMT, then replace the default input with the real
      // input.
      input = easyturk.getInput(DEFAULT_INPUT);

      // Enable the task.
      if (!easyturk.isPreview()){
        enableTask();
      }

      // Set up the correct.
      _.each(input, function() {
          cause_directions.push(null);
          confounders.push(null);
          confidences.push(null);
      });

      // Preload all images
      _.each(input, function(input_elem) {
          _.each(['joint_url','marginal_url_x','marginal_url_y'],function(img_key){
              var imgUrl = input_elem[img_key];
              var img = new Image();
              img.onload = function() { console.log('loaded image from ' + imgUrl); };
              img.src = imgUrl;
          })
      });

      render();
    }

    // Use the current index to update the image and description
    function render() {

        console.log("submit-btn",$('#submit-btn'))
        console.log("enabled",enabled)
        console.log("easyturk.isPreview()",easyturk.isPreview())

        const X = input[idx]['word_X'];
        const Y = input[idx]['word_Y'];

        //Set up text showing variables
        var xANDy = document.getElementById("x-and-y-text");
        xANDy.innerHTML = "The two objects to consider are: " + X.bold() + ' and ' + Y.bold();

        // Set up the images
        $('#image-container').empty();
        var img_keys = ['marginal_url_x','marginal_url_y','joint_url'];
        var word_for_img_keys = {'marginal_url_x':X,'marginal_url_y':Y,'joint_url':X + ' and ' + Y}
        let count = img_keys.length;

        for(var i = 0; i < count; i++) {
            var img_key = img_keys[i];
            let url = input[idx][img_key];
            if (url != ''){
                const newdiv = document.createElement( "div" );
                newdiv.class='flex-item'
                newdiv.style.textAlign = "center";
                // and give it some content
                const text_div = document.createElement( "div" );
                text_div.className = "row justify-content-center";
                let text = document.createElement("B");
                let non_bold_text = document.createTextNode(word_for_img_keys[img_key]);
                text.appendChild(non_bold_text)
                const img_div = document.createElement( "div" );
                img_div.className = "row justify-content-center";
                var img = document.createElement('img');
                img.src =  url
                // add the text node to the newly created div
                text_div.appendChild(text);
                img_div.appendChild(img);
                newdiv.appendChild(text_div);
                newdiv.appendChild(img_div);
                $( "#image-container" ).append( newdiv );
            }

       }


        const attrs_for_radio_label_id = {"x-to-y-label":['word_X','word_Y'],'y-to-x-label':['word_Y','word_X']};
        const l =["x-to-y-label","y-to-x-label"];
        let count2 = l.length;
        for(var i = 0; i < count2; i++) {
            var radio_label_id = l[i];
            var radio_label = document.getElementById(radio_label_id);
            var first = input[idx][attrs_for_radio_label_id[radio_label_id][0]]
            var second = input[idx][attrs_for_radio_label_id[radio_label_id][1]]
            // remove previous label (but not the radio element)
            if (radio_label.lastChild.nodeType == Node.TEXT_NODE) {
                radio_label.removeChild(radio_label.lastChild)
            }
            radio_label.appendChild(document.createTextNode("\u00A0\u00A0" + first + ' \u2192 ' + second + ': Changing the presence of ' + first + ' would influence the presence of ' + second));

      }
        var cradio_label = document.getElementById('z-to-xy-label');
            if (cradio_label.lastChild.nodeType == Node.TEXT_NODE) {
                cradio_label.removeChild(cradio_label.lastChild)
            }
        cradio_label.appendChild(document.createTextNode("\u00A0\u00A0" +  X + ' \u2190 ' + 'something else' + ' \u2192 ' + Y));

        var synradio_label = document.getElementById('x-is-y-label');
            if (synradio_label.lastChild.nodeType == Node.TEXT_NODE) {
                synradio_label.removeChild(synradio_label.lastChild)
            }
        synradio_label.appendChild(document.createTextNode("\u00A0\u00A0" + X +  ' and ' + Y +' are synonyms (they are different words for the same thing)'));
      // Clear radio responses when going to next page
      _.each(['cause-direction','confidence'], function(key) {
          let ele = document.getElementsByName(key);
          for(let i=0;i<ele.length;i++){
          ele[i].checked = false;
      }
      });



      // Set up the input fields
      $('#cause_direction').val(cause_directions[idx]);
      $('#confounder').val(confounders[idx]);
      $('#confidence').val(confidences[idx]);

      // Refresh the counter
      $('.counter-top').text(idx + 1);
      $('.counter-bottom').text(input.length);

      // If the UI is enabled, enable or disable the buttons depending on
      // the index.
      if (enabled) {
        $('#prev-btn').prop('disabled', false);
        $('#next-btn').prop('disabled', false);
        if (idx == 0) {
          $('#prev-btn').prop('disabled', true);
        }
        if (idx == input.length - 1) {
          $('#next-btn').prop('disabled', true);
        }
      }
    }

    // Update the index, and save the text in the text area.
    function setIdx(newIdx) {
      if (newIdx < 0 || newIdx >= input.length) return;
      idx = newIdx;
      render();
    }

    function saveResponse() {

        var ca;
        var cr = $('#confounder').val();
        var cn;
        var ca_radios = document.getElementsByName('cause-direction');

        for (let i = 0, length = ca_radios.length; i < length; i++) {
          if (ca_radios[i].checked) {
            ca = ca_radios[i].value

            // only one radio can be logically checked, don't check the rest
            break;
          }
        }

        var cn_radios = document.getElementsByName('confidence');
        for (let i = 0, length = cn_radios.length; i < length; i++) {
          if (cn_radios[i].checked) {
            cn = cn_radios[i].value

            // only one radio can be logically checked, don't check the rest
            break;
          }
        }

        cause_directions[idx] = ca;
        confounders[idx] = cr;
        confidences[idx] = cn;
        console.log("Cause directions:",cause_directions)
        console.log(confounders)
        console.log(confidences)
        return true;
    }

    // Enable the UI.
    function enableTask() {
      enabled = true;
      easyturk.setupSubmit();

      // Enable components
      $('#next-btn').click(function() {
          if (saveResponse()) {
              setIdx(idx + 1);
          }
      });
      $('#prev-btn').click(function() {
          if (saveResponse()) {
              setIdx(idx - 1);
          }
      });
      $('#submit-btn').prop('disabled', false);

      $('#submit-btn').click(function() {
        // Make sure to save the last one.
        if (!saveResponse()) {
          return false;
        }
        for (var i = 0; i < input.length; i++) {
            if (typeof(cause_directions[i]) == "undefined") {
                alert('You did not select a cause direction for  #' + (i+1));
                return false;
          }
            if ((cause_directions[i] === "z-to-xy") && ((confounders[i] == null || (confounders[i].length === 0)))) {
                alert('You selected "something else" for  #' + (i+1) + " but left the text field blank. Please put '?' if you cannot think of a good confounder.");
                return false;
          }
            if (typeof(confidences[i]) == "undefined") {
                alert('You did not select a confidences for  #' + (i+1));
                return false;
          }
        }

        // Copy the url and captions to the output we will return to the requester.
        var output = input;
        for (let i = 0; i < output.length; i++) {
          output[i]['cause_directions'] = cause_directions[i];
          output[i]['confounders'] = confounders[i];
          output[i]['confidences'] = confidences[i];
        }
        if (easyturk.isPreview()) {
          alert("This is only a preview. Here is your output: \n" + JSON.stringify(output));
          return false;
        } else {
          easyturk.setOutput(output);
          return true;
        }
      });
    }

    main();
  </script>
</body>
</html>
